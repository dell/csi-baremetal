name: devkit

on:
  push:
    branches: [ master ]
  issue_comment:
    types: [ created ]

env:
  LATEST_TAG: latest
  REGISTRY: ghcr.io/yurkov-anton/csi-baremetal
  equeal_with_latest: false
  docker_version: "1.16.8"

jobs:
  build:
    # we need to start validation on master push or on /ci comment in PR only
    if: github.event_name == 'push' || (github.event.issue.pull_request && github.event_name == 'issue_comment')
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Get version
      working-directory: devkit
      run: |
          echo "IMAGE_NAME=$( make repo )" >> $GITHUB_ENV
          echo "IMAGE_TAG=$( make version )" >> $GITHUB_ENV

    - name: Set env variables
      run: |          
          echo "LOCAL_IMAGE=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "DEST_IMAGE=${{env.REGISTRY}}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "LATEST_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.LATEST_TAG }}" >> $GITHUB_ENV

    - name: Pull latest csi-baremetal-devkit
      continue-on-error: true
      run: docker pull ${{ env.LATEST_IMAGE }}

    - name: Build devkit image
      working-directory: devkit
      run: make build
    
    - name: Check equeal with latest
      continue-on-error: true
      working-directory: devkit
      run: |
          echo "equeal_with_latest=$(make is-equal-with COMPARE_IMAGE=${{ env.LATEST_IMAGE }})" >> $GITHUB_ENV
          echo "${{ env.equeal_with_latest != 'true' }}"
          
    - name: Push devkit
      working-directory: devkit
      if: env.equeal_with_latest != 'true'
      run: |
        echo "${{ env.equeal_with_latest != 'true' }}"
        # Push current image
        docker tag ${{ env.LOCAL_IMAGE }} ${{ env.DEST_IMAGE }}
        docker push ${{ env.DEST_IMAGE }}
        # Update latest image
        docker tag ${{ env.DEST_IMAGE }} ${{ env.LATEST_IMAGE }}
        docker push ${{ env.LATEST_IMAGE }}
        
